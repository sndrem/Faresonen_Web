{"version":3,"sources":["../../src/services/SocketFeeder.js"],"names":["io","require","SocketFeeder","server","console","log","pingInterval","pingTimeout","connectedUsers","interval","connection","sockets","on","push","socket","length","startFeed","index","indexOf","splice","clearInterval","testData","events","event","eventtype","eventtime","extendedeventtype","goalsTeamA","goalsTeamB","id","match","person1","realTime","team","enetpulseId","eventMin","nifsId","text","emit","yesterday","getYesterday","setInterval","altomfotballScraper","getYellowCardEvents","then","data","catch","err","getTestEvents","now","subtract","add","month","year","day","date","formatDateString"],"mappings":"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","file":"SocketFeeder.js","sourcesContent":["import moment from \"moment\";\nimport altomfotballScraper from \"../services/altomfotballScraper\";\n\nconst io = require(\"socket.io\");\n\nclass SocketFeeder {\n  constructor(server) {\n    console.log(\"Setting up socket-feeder\");\n    this.io = io(server, {\n      pingInterval: 10000,\n      pingTimeout: 5000\n    });\n    this.connectedUsers = [];\n    this.interval = null;\n    this.connection();\n  }\n\n  connection() {\n    this.io.sockets.on(\"connection\", socket => {\n      console.log(\"A new user connected\");\n      this.connectedUsers.push(socket);\n      console.log(\n        `Number of connected users are ${this.connectedUsers.length}`\n      );\n\n      this.startFeed();\n      // this.startTestFeed();\n\n      socket.on(\"disconnect\", () => {\n        console.log(\"User disconnected\");\n        const index = this.connectedUsers.indexOf(socket);\n        this.connectedUsers.splice(index, 1);\n        console.log(\n          `Number of connected users are: ${this.connectedUsers.length}`\n        );\n        if (this.connectedUsers.length <= 0) {\n          console.log(\"No users left, clearing interval\");\n          clearInterval(this.interval);\n        }\n      });\n    });\n  }\n\n  sendData() {\n    const testData = {\n      events: {\n        \"-uri\": \"http://api.tv2.no/sport/resources/events/\",\n        event: [\n          {\n            \"-uri\": \"http://api.tv2.no/sport/resources/events/15221417/\",\n            eventtype: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/eventtypes/2/\"\n            },\n            eventtime: \"41\",\n            extendedeventtype: {\n              \"-uri\":\n                \"http://api.tv2.no/sport/resources/extendedeventtypes/1200/\"\n            },\n            goalsTeamA: \"1\",\n            goalsTeamB: \"0\",\n            id: \"15221417\",\n            match: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/matches/912485/\"\n            },\n            person1: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/people/345617/\"\n            },\n            realTime: \"2018-03-18T18:46:57+01:00\",\n            team: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/teams/307/\"\n            }\n          },\n          {\n            \"-uri\": \"http://api.tv2.no/sport/resources/events/15222082/\",\n            enetpulseId: \"5491684\",\n            eventMin: \"84\",\n            eventtype: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/eventtypes/2/\"\n            },\n            eventtime: \"84\",\n            extendedeventtype: {\n              \"-uri\":\n                \"http://api.tv2.no/sport/resources/extendedeventtypes/1200/\"\n            },\n            goalsTeamA: \"2\",\n            goalsTeamB: \"0\",\n            id: \"15222082\",\n            match: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/matches/912485/\"\n            },\n            nifsId: \"8630875\",\n            person1: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/people/207243/\"\n            },\n            realTime: \"2018-03-18T19:50:24+01:00\",\n            team: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/teams/307/\"\n            },\n            text: \"Stopper en Brann-kontring. Riktig idømt.\"\n          },\n          {\n            \"-uri\": \"http://api.tv2.no/sport/resources/events/15222085/\",\n            eventtype: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/eventtypes/2/\"\n            },\n            eventtime: \"85\",\n            extendedeventtype: {\n              \"-uri\":\n                \"http://api.tv2.no/sport/resources/extendedeventtypes/1200/\"\n            },\n            goalsTeamA: \"0\",\n            goalsTeamB: \"1\",\n            id: \"15222085\",\n            match: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/matches/912482/\"\n            },\n            person1: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/people/279765/\"\n            },\n            realTime: \"2018-03-18T19:50:25+01:00\",\n            team: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/teams/309/\"\n            }\n          },\n          {\n            \"-uri\": \"http://api.tv2.no/sport/resources/events/15222633/\",\n            eventtype: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/eventtypes/2/\"\n            },\n            eventtime: \"36\",\n            extendedeventtype: {\n              \"-uri\":\n                \"http://api.tv2.no/sport/resources/extendedeventtypes/1200/\"\n            },\n            goalsTeamA: \"0\",\n            goalsTeamB: \"0\",\n            id: \"15222633\",\n            match: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/matches/912487/\"\n            },\n            nifsId: \"8631283\",\n            person1: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/people/194694/\"\n            },\n            realTime: \"2018-03-18T20:37:58+01:00\",\n            team: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/teams/314/\"\n            },\n            text:\n              \"Alt for sent inne i en takling på Jone Samuelsen. Frispark til Odd i svært god posisjon.\"\n          },\n          {\n            \"-uri\": \"http://api.tv2.no/sport/resources/events/15222908/\",\n            eventtype: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/eventtypes/2/\"\n            },\n            eventtime: \"65\",\n            extendedeventtype: {\n              \"-uri\":\n                \"http://api.tv2.no/sport/resources/extendedeventtypes/1200/\"\n            },\n            goalsTeamA: \"2\",\n            goalsTeamB: \"1\",\n            id: \"15222908\",\n            match: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/matches/912487/\"\n            },\n            nifsId: \"8631530\",\n            person1: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/people/291489/\"\n            },\n            realTime: \"2018-03-18T21:24:57+01:00\",\n            team: {\n              \"-uri\": \"http://api.tv2.no/sport/resources/teams/314/\"\n            }\n          }\n        ]\n      }\n    };\n    this.io.emit(\"data\", {\n      testData\n    });\n  }\n\n  static getYesterday() {\n    const now = moment().subtract(1, \"days\");\n    now.add(1, \"month\");\n    const month = now.month();\n    const year = now.year();\n    const day = now.date();\n    return SocketFeeder.formatDateString(year, month, day);\n  }\n\n  static formatDateString(year, month, day) {\n    return `${year}-${month >= 10 ? month : \"0\" + month}-${\n      day >= 10 ? day : \"0\" + day\n    }`;\n  }\n\n  startFeed() {\n    if (this.interval) clearInterval(this.interval);\n\n    if (this.connectedUsers.length > 0) {\n      if (this.interval) clearInterval(this.interval);\n\n      const yesterday = SocketFeeder.getYesterday();\n\n      this.interval = setInterval(() => {\n        altomfotballScraper\n          .getYellowCardEvents(yesterday)\n          .then(data => {\n            console.log(\"Emitting data to clients\");\n            this.io.emit(\"data\", data);\n          })\n          .catch(err => {\n            console.log(`Error fetch yellow card events`, err);\n            this.io.emit(\"data\", {});\n          });\n      }, 10000);\n    }\n  }\n\n  startTestFeed() {\n    const data = altomfotballScraper.getTestEvents();\n    this.io.emit(\"data\", { events: data });\n    if (this.connectedUsers.length > 0) {\n      if (this.interval) clearInterval(this.interval);\n      this.interval = setInterval(() => {\n        console.log(\"Emitting test data\");\n        this.io.emit(\"data\", { events: data });\n      }, 5000);\n    }\n  }\n}\n\nexport default SocketFeeder;\n"]}